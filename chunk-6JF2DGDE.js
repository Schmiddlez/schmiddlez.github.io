import{a as F}from"./chunk-JLWIDV3F.js";import{d as A,e as T}from"./chunk-KE4LITEF.js";import{B as I,G as m,S as k,a as N,ca as c,ha as u,o as p,q as S,r as M,u as l,ya as h}from"./chunk-W56RDURX.js";var g=class r{static{this.APP_NAME="Comic"}static{this.MAX_APPLICATIONS=2}static{this.COMIC_PAGE_PADDING=16*1.5}static{this.WIDTH_HIDE_SIDE_CONTENT=950}static{this.SCROLL_LOAD_DELAY=750}static{this.MINUTE=1e3*60}static{this.HOUR=1e3*60*60}static{this.DAY=1e3*60*60*24}static{this.COUNTRY_NAMES=new Intl.DisplayNames(["en"],{type:"region"})}static{this.COUNTRY_LANGUAGES=new Intl.DisplayNames(["en"],{type:"language"})}static{this.COMIC_APP={appName:"Comic",apiUrl:"https://<my_api_url>/api/v1",baseAuthorizationUrl:"https://schmiddlez.github.io/comic/oauth2/authorize"}}static when(s){if(!s)return"--- --- ---";let t=new Date().getTime()-new Date(s).getTime();return t>r.DAY?`${Math.floor(t/r.DAY)} days ago`:t>r.HOUR?`${Math.floor(t/r.HOUR)} hrs ago`:`${Math.floor(t/r.MINUTE)} min ago`}static comicMarks(s,t){let e=t.settings?.comicMarkSettings.filter(o=>o.enabled),i=[];if(e){let o=s.genres.map(n=>n.id),a=s.themes.map(n=>n.id);for(let n of e)o.includes(n.categoryId)&&i.push(n.color),a.includes(n.categoryId)&&i.push(n.color)}return i}static anonymous(){return{id:0,username:"anonymous",displayName:"Anonymous",followedComics:[],followedStaff:[],readingHistory:[],comicLists:[],userLogs:[],settings:r.emptySettings()}}static emptySettings(){return{privacySettings:{privateFollowing:!1,invisibleFollowing:!1,privateLists:!1,invisibleLists:!1,privateHistory:!1,invisibleHistory:!1},authorizedApps:[],comicPreferences:{displayFollows:!0,languages:[],title:"",quickFollow:""},comicMarkSettings:[],comicFilterSettings:{categoryFilters:[],enableMatureContent:!1}}}static emptyFilter(){return{title:"",categories:[],excludedCategories:[],chapters:0,status:"",comicTypes:[],demographics:[],releasedFrom:"",releasedTo:"",lastUpdated:"",contentRating:"",matureContent:!1,includeFollowing:!0,sort:"ID",desc:!1}}static emptyApp(){return{id:0,userId:0,clientName:"New App",description:"",link:"",redirectUris:[]}}static emptyComic(){return{id:0,title:"",chapters:0,volumes:0,type:"",format:"",status:"",startDate:"",source:"",countryOfOrigin:"",isLicensed:!1,isAdult:!1,isLocked:!1,meanScore:0,averageScore:0,popularity:0,favourites:0,isFavouriteBlocked:!1,isFavourite:!1,isRecommendationBlocked:!1,isReviewBlocked:!1,aliases:[],covers:[],genres:[],themes:[],tags:[],links:[],characters:[],publishers:[],staff:[],relations:[],recommendations:[],created:new Date,updated:new Date}}static appendComics(s,t){let e=[...s];for(let i of t)e.findIndex(a=>a.id==i.id)<0&&e.push(i);return e}static appendComicMappers(s,t){let e=[...s];for(let i of t)e.findIndex(a=>a.comic.id==i.comic.id)<0&&e.push(i);return e}static countryName(s,t="en"){return new Intl.DisplayNames([t],{type:"region"}).of(s)}static countryLanguage(s,t="en"){let i=new Intl.DisplayNames([t],{type:"language"}).of(s);return console.log(i),i}static authMatcher(s){let t=s.map(e=>e.path);return t.includes("login")||t.includes("register")?{consumed:s}:null}};var y=class{constructor(s,t){this.status=s,this.message=t.message,this.path=t.path,this.name=t.path[0],this.cause=t}};var b=(()=>{class r{constructor(){this.notificationMap=new Map,this.notifications=h([]),this.notifications$=this.notifications.asReadonly(),this.counter=1}notify(t,e=3e3){let i=this.counter++,o=N({id:i},t);this.notificationMap.set(i,o),setTimeout(()=>{this.removeNotif(i)},e),this.update()}removeNotif(t){this.notificationMap.delete(t),this.update()}clear(){this.notificationMap.clear(),this.update()}update(){this.notifications.update(t=>Array.from(this.notificationMap.entries()).map(e=>e[1]))}static{this.\u0275fac=function(e){return new(e||r)}}static{this.\u0275prov=c({token:r,factory:r.\u0275fac,providedIn:"root"})}}return r})();var w=class{constructor(s,t,e,i){this.name=s,this.fields=t||[],this.nestedFields=e||[],this.variables=i,this.builder=this}addNestedField(s){return this.nestedFields?.push(s),this}withNestedField(s,t,e){let i=new f(this,s,t,e);return this.nestedFields?.push(i),this}in(s,t){return this.nestedField(s,t)}nestedField(s,t,e){let i=new f(this,s,t,e);return this.nestedFields?.push(i),i}withField(s){return this.fields.push(s),this}withFields(...s){return this.fields.push(...s),this}withVariable(s,t,e){return this.variables||(this.variables={}),this.variables[s]={value:t,type:e},this}},f=class extends w{constructor(s,t,e,i,o){super(t,e,i,o),this.builder=s}then(){return this.builder}},d=class r extends w{constructor(s,t,e,i,o){super(t,e,i,o),this.sets=new Map,this.requestType=s,this.query=t}on(s){if(this.sets.has(s))return this.sets.get(s);let t=new f(this,s);return this.sets.set(s,t),t}build(){let s=this.variables?Object.entries(this.variables):[],t={},e=this.construct(this,t),i=Object.entries(t).length<=0?"":`(${s.map(o=>`$${o[0]}: ${o[1].type}`)})`;return{query:`${this.requestType}${i} {${e}}`,variables:t,meta:this.name}}construct(s,t={}){let e=[];if(e.push(s.name),s.variables){let i=Object.entries(s.variables);for(let o of i){let a=o[0],n=o[1].value;t[a]=n}i.length>0&&e.push(`(${i.map(o=>`${o[0]}: $${o[0]}`)})`)}if(e.push("{"),s.fields.length>0&&e.push(s.fields.join(" ")),s.nestedFields&&s.nestedFields.length>0&&e.push(s.nestedFields?.map(i=>this.construct(i,t)).join(" ")||""),s instanceof r)for(let i of s.sets.values())e.push(`... on ${this.construct(i)}`);return e.push("}"),e.join(" ")}onlyHere(){}then(){return this.builder}};var D=(()=>{class r{constructor(){this.notifService=u(b),this.url=`${F.comic()}/graphql`,this.http=u(T)}createQuery(t,e){return new d("query",t,[],[],e)}createMutation(t,e){return new d("mutation",t,[],[],e)}createGqlField(t,e,i){return{name:t,fields:[...e],nestedFields:i?[...i]:[]}}performQuery(t,e=!0,i){return this.performApiRequest(t,e,i)}performMutation(t,e=!0,i){return this.performApiRequest(t,e,i)}performApiRequest(t,e=!0,i){return e?this.http.post(this.url,{query:t.query,variables:t.variables,meta:t.meta}).pipe(l(o=>this.castData(o,t.meta)),m((o,a)=>this.httpError(o,a,i))):this.http.post(this.url,{query:t.query,variables:t.variables,meta:t.meta}).pipe(l(o=>this.castData(o,t.meta)))}httpError(t,e,i){return console.log(t),t.status==0?(this.notifService.notify({type:"bad",header:"Network Error",body:"Could not connect to server"}),p):t.status==401?(this.notifService.notify({type:"bad",header:"Please Log In",body:"You must be logged in to do this"},5e3),p):t.status==403?(this.notifService.notify({type:"bad",header:"Not Allowed",body:"You do not have required permissions"},5e3),p):(this.notifService.notify({type:"bad",header:"Unknown error",body:i??"Something didn't work right, sorry"}),M(()=>t))}castData(t,e,i){if(t.data[e]!=null)return t.data[e];if(t.errors){let o=parseInt(t.errors[0].extensions.classification);throw new y(o,t.errors[0])}if(i)return i;throw new Error("unknown error")}static{this.\u0275fac=function(e){return new(e||r)}}static{this.\u0275prov=c({token:r,factory:r.\u0275fac,providedIn:"root"})}}return r})();var x=(()=>{class r{constructor(){this.token=h(void 0),this.comicData=h({categories:[],demographics:[],comicTypes:[]});let t=this.getToken();t&&this.token.set(t);let e=this.getComicData();e&&this.comicData.set(e)}storeComicData(t){this.comicData.set(t),localStorage.setItem("comic-data",JSON.stringify(t))}getComicData(){let t=localStorage.getItem("comic-data");if(t)return JSON.parse(t)}clearComicData(){sessionStorage.removeItem("comic-data")}storeUser(t){sessionStorage.setItem("comic-user",JSON.stringify(t))}clearUser(){sessionStorage.setItem("comic-user",JSON.stringify(g.anonymous()))}storeToken(t){this.token.set(t),localStorage.setItem("comicToken",JSON.stringify(t))}getToken(){let t=localStorage.getItem("comicToken");if(t)return JSON.parse(t)}clearToken(){localStorage.removeItem("comicToken"),this.token.set(void 0)}static{this.\u0275fac=function(e){return new(e||r)}}static{this.\u0275prov=c({token:r,factory:r.\u0275fac,providedIn:"root"})}}return r})();var C=(()=>{class r{constructor(){this.api=u(D),this.storage=u(x),this.notifService=u(b)}static{this.\u0275fac=function(e){return new(e||r)}}static{this.\u0275prov=c({token:r,factory:r.\u0275fac,providedIn:"root"})}}return r})();var nt=(()=>{class r extends C{constructor(){super()}usernameAvailable$(t){return this.api.performMutation({query:`query { usernameAvailable(username: "${t}") }`,meta:"usernameAvailable"},!1)}login$(t,e){let i=this.api.createMutation("login").withVariable("credentials",{username:t,password:e},"UserSignIn!").withNestedField("user",["id","username","displayName"]).withNestedField("token",["userId","accessToken","refreshToken","issuedAt","accessExpiry","refreshExpiry"]).build();return this.api.performMutation(i,!1).pipe(k(this.authRetry))}logout$(){return this.api.performMutation({query:"mutation { logout }",meta:"logout"},!1).pipe(m(t=>S(!0)))}register$(t,e,i){let o=this.api.createMutation("register").withVariable("credentials",{username:t,displayName:e,password:i},"UserRegistration").withNestedField("user",["id","username","displayName"]).withNestedField("token",["userId","accessToken","refreshToken","issuedAt","accessExpiry","refreshExpiry"]).build();return this.api.performMutation(o,!1).pipe(k(this.authRetry))}refreshToken$(t){let e=this.api.createMutation("refresh").withVariable("refreshToken",t,"String!").withNestedField("token",["userId","clientId","accessToken","refreshToken","issuedAt","accessExpiry","refreshExpiry"]).build();return this.api.performMutation(e,!1).pipe(l(i=>{let o=i.data.refreshToken,a=i.errors;if(o)return o;if(a)for(let n of a)n.extensions.classification.includes("401")&&(this.storage.clearToken(),this.storage.clearUser());throw new Error("500")}))}authorize$(t){let e=this.api.createMutation("authorize").withVariable("request",t,"AuthorizationRequest!");return e.withFields("userId","clientId","responseType","code"),e.withNestedField("token",["userId","clientId","accessToken","issuedAt","accessExpiry"]),this.api.performMutation(e.build(),!1)}get authRetry(){return{count:1,delay:(t,e)=>t instanceof A?((t.status===401||t.status===0)&&this.storage.clearToken(),I(500)):I(500)}}static{this.\u0275fac=function(e){return new(e||r)}}static{this.\u0275prov=c({token:r,factory:r.\u0275fac,providedIn:"root"})}}return r})();export{d as a,g as b,y as c,b as d,D as e,x as f,C as g,nt as h};
